<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>即時聊天程式</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #chat {
            width: 400px;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
        }
        #userList {
            width: 400px;
            margin: 0 auto 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        #messageInput {
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>即時聊天程式</h1>
    <div>
        <label>使用者名稱: <input type="text" id="username" placeholder="請輸入名稱"></label>
        <button id="joinBtn">加入聊天室</button>
    </div>
    <!-- 顯示聊天室使用者清單 -->
    <div id="userList">目前聊天室人員：尚未加入</div>
    <!-- 聊天訊息區塊 -->
    <div id="chat"></div>
    <div>
        <input type="text" id="messageInput" placeholder="輸入訊息">
        <button id="sendBtn">送出訊息</button>
    </div>
    
    <!-- 引入 Socket.IO 客戶端庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <script>
        const socket = io();
        const chatDiv = document.getElementById("chat");
        const userListDiv = document.getElementById("userList");
        const joinBtn = document.getElementById("joinBtn");
        const sendBtn = document.getElementById("sendBtn");
        const usernameInput = document.getElementById("username");
        const messageInput = document.getElementById("messageInput");

        let joined = false;

        // 更新聊天室的人員清單
        function updateUserList(users) {
            if (users.length === 0) {
                userListDiv.innerText = "目前聊天室人員：尚未加入";
            } else {
                userListDiv.innerText = "目前聊天室人員：" + users.join(", ");
            }
        }

        // 加入聊天室
        joinBtn.addEventListener("click", () => {
            const username = usernameInput.value.trim();
            if(username) {
                socket.emit("join", { username: username });
                joined = true;
            } else {
                alert("請輸入使用者名稱");
            }
        });

        // 送出訊息
        sendBtn.addEventListener("click", () => {
            if(!joined) {
                alert("請先加入聊天室！");
                return;
            }
            const username = usernameInput.value.trim();
            const msg = messageInput.value.trim();
            if(msg) {
                socket.emit("message", { username: username, msg: msg });
                messageInput.value = "";
            }
        });

        // 顯示狀態訊息
        socket.on("status", data => {
            const p = document.createElement("p");
            p.innerText = data.msg;
            p.style.color = "blue";
            chatDiv.appendChild(p);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            if(data.users) {
                updateUserList(data.users);
            }
        });

        // 顯示聊天訊息
        socket.on("message", data => {
            const p = document.createElement("p");
            p.innerText = data.msg;
            chatDiv.appendChild(p);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        // 更新聊天室使用者清單
        socket.on("user_list", data => {
            if(data.users) {
                updateUserList(data.users);
            }
        });

        socket.on("disconnect", () => {
            const p = document.createElement("p");
            p.innerText = "連線中斷，請稍後再試。";
            p.style.color = "red";
            chatDiv.appendChild(p);
        });
    </script>
</body>
</html>
